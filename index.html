<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>ESP32 BLE –°–µ—Ä–≤–æ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  body { font-family: Arial; text-align: center; padding: 20px; }
  button { width: 140px; height: 50px; margin: 8px; font-size: 16px; }
  .servo-block { margin-top: 20px; text-align: center; max-width: 420px; margin-left: auto; margin-right: auto; }
  label { font-size: 16px; }
  input[type="range"] { width: 100%; }
</style>
</head>
<body>
<h2>ESP32 BLE ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–æ</h2>
<button id="connectBtn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
<p id="status">–û—Ç–∫–ª—é—á–µ–Ω–æ</p>

<div class="servo-block">
  <h3>–°–µ—Ä–≤–æ</h3>
  <label>–£–≥–æ–ª: <span id="servoVal">90</span>¬∞</label><br>
  <input type="range" min="0" max="180" value="90" id="servo" />
</div>

<script>
let device, server, service, rxChar;

// UUIDs –≤ lowercase (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ Web Bluetooth –≤ JS)
const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const RX_UUID      = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";

async function connectBLE() {
  try {
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [SERVICE_UUID]
    });

    server = await device.gatt.connect();
    service = await server.getPrimaryService(SERVICE_UUID);
    rxChar = await service.getCharacteristic(RX_UUID);

    document.getElementById("status").innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ";
  } catch (e) {
    alert("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " + e);
  }
}

document.getElementById("connectBtn").onclick = connectBLE;

function send(msg) {
  if (!rxChar) return;
  try {
    rxChar.writeValue(new TextEncoder().encode(msg + "\n"));
  } catch (err) {
    console.error("Send error:", err);
  }
}

const servoSlider = document.getElementById("servo");
const servoLabel = document.getElementById("servoVal");
let last = 90;

servoSlider.oninput = () => {
  servoLabel.innerText = servoSlider.value;
};

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —É–≥–ª–∞ —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–∞ (–Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞ u2<angle>)
setInterval(() => {
  let val = parseInt(servoSlider.value);
  if (val !== last) {
    last = val;
    send("u2" + val);
  }
}, 120);
</script>
</body>
</html>
